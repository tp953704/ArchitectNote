# Google Kubernetes Engine (GKE) 設計與管理指南

## 目錄
1. [GKE 設計考量](#gke-設計考量)
2. [GKE 安全管理](#gke-安全管理)
3. [GKE 網路架構](#gke-網路架構)
4. [GKE 工作負載管理](#gke-工作負載管理)

---

## GKE 設計考量

### 高可用性叢集
- **區域性叢集 (Regional Clusters)**
  - 控制平面和節點跨多個區域複製
  - 關鍵優勢：
    - 單一區域故障恢復能力
    - 持續升級/提高可用性
  - 設計考量：
    - 預設節點池配置（9個節點，3個區域）
    - 跨區域流量成本
    - 超額配置擴展限制（例如150%容量）

### 多租戶架構
- **GKE 多租戶叢集**
  - 單一K8s叢集共享給多用戶/工作負載
  - 優勢：
    - 降低成本（共享資源）
    - 增加靈活性
    - 簡化管理
  - 安全隔離層級：
    - 命名空間、節點、Pod、容器層級隔離
  - 最佳實踐：
    - 參考[企業多租戶最佳實踐](https://cloud.google.com/kubernetes-engine/docs/best-practices/enterprise-multitenancy)

### 服務網格 (Service Mesh)
- **Anthos Service Mesh**
  - 基於Istio的開源服務網格平台
  - 核心功能：
    - 流量管理
    - 服務註冊
    - 可觀測性洞察
    - 安全認證（mTLS）

### 備份與恢復
- **GKE 備份服務**
  - 備份場景：
    - 災難恢復
    - CI/CD管道
    - 工作負載克隆
  - 架構組成：
    - 備份API（控制平面）
    - 備份代理（執行備份/恢復操作）
  - 注意事項：
    - 不備份叢集配置、容器鏡像、外部服務

---

## GKE 安全管理

### 責任共擔模型
| Google責任 | 客戶責任 |
|------------|----------|
| 基礎設施保護 | 工作負載管理 |
| 節點OS加固與修補 | 叢集升級管理 |
| 控制平面管理 | 監控與事件響應 |
| 威脅檢測 | 提供環境細節 |

### 認證與授權
- **雙層訪問控制**
  - **GCP IAM**：項目級權限管理
  - **K8s RBAC**：叢集內精細權限控制
- **服務帳戶類型**
  - K8s服務帳戶（叢集內身份）
  - GCP IAM服務帳戶（項目級身份）
  - GKE服務代理（Google管理）

### 安全強化措施
- **控制平面安全**
  - 硬化OS、TLS加密、證書輪換、訪問審計
- **節點安全**
  - 容器優化OS(COS)
  - 自動節點升級
  - 工作負載身份（限制元數據訪問）
- **Pod安全**
  - 限制權限（SecurityContext）
  - 二進制授權（僅部署受信任鏡像）

### 數據加密
- **三態加密**
  | 狀態 | 加密方案 |
  |------|----------|
  | 靜態 | AES-256/Cloud KMS |
  | 傳輸 | TLS 1.2+/BoringSSL |
  | 使用 | 機密節點（Confidential VMs）|

---

## GKE 網路架構

### 網路基礎
- **IP分配模式**
  - 節點IP（VPC主範圍）
  - Pod IP（每節點/24 CIDR）
  - 服務IP（ClusterIP）
- **叢集類型**
  - **VPC原生叢集**（Alias IP，推薦）
    - 原生路由、細粒度防火牆
  - **基於路由叢集**（傳統靜態路由）

### 私有叢集
- **核心特性**
  - 僅使用內部IP
  - 節點/Pod無直接互聯網訪問
  - 可選組件：
    - Cloud NAT（出站訪問）
    - 私有Google訪問（訪問GCP服務）
- **架構分離**
  - Google管理項目（控制平面）
  - 客戶項目（工作負載）

### 負載均衡
- **服務類型**
  | 類型 | 特點 | 適用場景 |
  |------|------|----------|
  | External LB | 公開IP | 互聯網訪問 |
  | Internal LB | 內部IP | VPC內通訊 |
- **容器原生LB**
  - 直接路由到Pod（NEGs）
  - 優勢：低延遲、Pod生命周期感知

### Ingress 控制器
- **流量管理**
  - 外部Ingress：面向互聯網
  - 內部Ingress：區域L7代理
- **配置注意**
  - 避免手動修改LB對象（會被GKE覆蓋）

---

## GKE 工作負載管理

### 工作負載類型
| 類型 | 控制器 | 用例 |
|------|--------|------|
| 無狀態 | Deployment | Web前端 |
| 有狀態 | StatefulSet | 數據庫 |
| 批處理 | Job | 離線任務 |
| 守護進程 | DaemonSet | 日誌收集 |

### 遷移策略
- **VM遷移工具**
  - 適合度評估工具（生成遷移報告）
  - 支持平台：VMware/AWS/Azure/GCP
- 遷移評分等級：
  - 優秀適合 → 需要重大改進

### 節點污點調度
- **核心概念**
  - **污點(Taint)**：節點排斥規則
  - **容忍(Toleration)**：Pod調度偏好
- **應用場景**
  - 批處理作業隔離
  - 遊戲伺服器專用硬體
  - 合規性要求隔離

### 滾動更新
- **更新策略**
  | 策略 | 特點 | 命令示例 |
  |------|------|----------|
  | OnDelete | 手動刪除觸發更新 | 預設行為 |
  | RollingUpdate | 自動漸進式更新 | 需顯式配置 |
- **觸發條件**
  - 僅修改Pod模板會觸發滾動更新
  - 擴縮容不觸發更新

  # GKE 深度學習課程總結與進階指南

## 課程總結

### 1. GKE 核心概念
- **GKE 本質**：Google 託管的 Kubernetes 服務
- **架構組成**：控制平面、節點池、網路組件
- **叢集模式**：
  - Autopilot（全託管）
  - Standard（標準模式）

# GKE Autopilot 與 Standard 模式詳細比較

## 核心差異總覽
| 特性                | Autopilot 模式                          | Standard 模式                          |
|---------------------|----------------------------------------|----------------------------------------|
| **管理責任**        | 完全託管（Google管理節點）             | 用戶自行管理節點                       |
| **定價模式**        | 按Pod資源使用量計費                    | 按節點VM規格計費（無論使用率）         |
| **適用場景**        | 快速部署、無需基礎架構管理             | 需要精細控制節點配置                   |

## 技術細節對比

### 1. 節點管理
| **項目**            | Autopilot                              | Standard                              |
|---------------------|---------------------------------------|---------------------------------------|
| 節點配置            | Google自動優化配置                    | 用戶自定義VM類型和大小                |
| 節點擴縮            | 自動即時伸縮（無需預配置）            | 需手動配置/啟用自動擴縮               |
| 節點維護            | 全自動（無需用戶干預）                | 需手動處理節點升級/維護               |
| 最大Pod數/節點      | 固定32個                              | 取決於節點類型（可達110個）           |

### 2. 資源配置
| **項目**            | Autopilot                              | Standard                              |
|---------------------|---------------------------------------|---------------------------------------|
| CPU/記憶體請求      | 強制要求精確指定                      | 可靈活設置（允許超賣）                |
| 持久卷              | 僅支持SSD                             | 支持SSD/標準HDD                       |
| 節點本地存儲        | 不可用                                | 可配置本地SSD                         |
| GPU資源             | 僅特定GPU類型                         | 支持全系列GPU                         |

### 3. 網路與安全
| **項目**            | Autopilot                              | Standard                              |
|---------------------|---------------------------------------|---------------------------------------|
| 節點OS              | 強制使用Container-Optimized OS        | 可選擇COS/Ubuntu                      |
| IP分配模式          | 僅VPC-native                          | 支持VPC-native/Route-based            |
| 節點SSH訪問         | 禁止                                  | 允許                                  |
| 自定義內核模組      | 不支持                                | 可通過DaemonSet加載                   |

### 4. 成本比較
```bash
# Autopilot 成本示例 (us-central1)
Pod配置：2vCPU+4GB記憶體
費用 = $0.0626(vCPU/hr) + $0.0085(記憶體/GB/hr) 
     = (0.0626*2) + (0.0085*4) = $0.1592/小時

# Standard 成本示例 (n2-standard-2)
節點規格：2vCPU+8GB記憶體
費用 = $0.0971/小時（無論Pod使用率）
```

### 2. 部署與管理
- **準備工作**：
  - `kubectl` 配置
  - 標籤(Labels)與標記(Tags)使用
    1. 主要使用場景 Tag
       - 防火牆規則控制
       - 網路路由配置
       - 成本分配與追蹤
- **擴展能力**：
  - 叢集自動擴展(Cluster Autoscaling)
  - 節點自動配置(Node Auto-provisioning)
- **維護操作**：
  - 升級叢集與節點池
  - 監控與日誌管理

### 3. 網路架構
- **叢集類型**：
  - 公共叢集（公開IP）
  - 私有叢集（僅內部IP）
- **網路模式**：
  - VPC原生（Alias IP，推薦）
  - 基於路由（傳統）
- **流量管理**：
  - Ingress 控制器
  - 服務負載均衡（L4/L7）

### 4. 安全管理
- **訪問控制**：
  - Kubernetes RBAC
  - GCP IAM 整合
- **網路策略**：
  - Pod間流量控制
- **數據保護**：
  - 應用層密文加密
  - 工作負載身份(Workload Identity)

### 5. 設計考量
- **高可用性**：
  - 區域叢集部署
  - 多區域控制平面
- **多租戶設計**：
  - 命名空間隔離
  - 資源配額管理
- **服務網格**：
  - Anthos Service Mesh
  - Istio 整合
- **備份方案**：
  - GKE 備份服務
  - 災難恢復策略

---

## 進階學習建議

### 1. 深化 GKE 知識
- **進階功能**：
  - 工作負載身份聯動
  - Pod安全策略(PSP)
  - 自定義資源定義(CRDs)
- **GCP 服務整合**：
  - Cloud Functions 無服務架構
  - BigQuery 數據分析
  - Cloud Storage 持久化存儲

### 2. Kubernetes 生態工具
| 工具類別       | 推薦工具                          | 用途                     |
|----------------|-----------------------------------|--------------------------|
| 包管理         | Helm                              | 應用打包與部署           |
| 運維自動化     | Kubernetes Operators             | 複雜應用生命周期管理     |
| 監控告警       | Prometheus + Grafana             | 指標監控與可視化        |
| 日誌分析       | Fluentd + Elasticsearch          | 集中式日誌管理          |

### 3. 混合雲與 Anthos
- **核心組件**：
  - Anthos Config Management（配置統一管理）
  - Anthos Service Mesh（跨雲服務網格）
- **應用場景**：
  - 混合雲部署
  - 多集群管理
  - 邊緣計算場景

### 4. 雲原生開發
- **關鍵技術**：
  - 容器化最佳實踐（12-factor應用）
  - 無服務架構（Cloud Run）
  - 事件驅動架構（Pub/Sub）
- **開發工具鏈**：
  - Skaffold（本地開發）
  - Tekton（CI/CD流水線）

---

## 實踐建議

1. **實戰項目**：
   - 部署三層架構應用（前端+API+數據庫）
   - 實現藍綠部署策略
   - 構建跨區域災備方案

2. **官方資源**：
   - [GKE 最佳實踐指南](https://cloud.google.com/kubernetes-engine/docs/best-practices)
   - [Anthos 白皮書](https://cloud.google.com/anthos/docs/concepts/overview)

3. **認證路徑**：
   - Google Cloud Associate Cloud Engineer
   - Professional Cloud Architect

> 提示：建議在沙箱環境中實驗進階功能，生產環境部署前充分測試網路策略和安全配置。

#### Q&A
1. GKE 如何處理容器映像管理？
```
Google Kubernetes Engine（GKE）使用「映像串流（Image Streaming）」技術來優化容器映像的拉取過程。這項功能允許工作負載在不等待整個映像下載完成的情況下啟動，從而顯著縮短初始化時間。映像串流特別適用於大型映像，能夠加快自動擴縮和 Pod 啟動的速度。在 GKE Autopilot 模式下，從版本 1.25.5-gke.1000 開始，新建立的叢集會自動啟用映像串流功能。 
Google Cloud
+1
Medium
+1
```

2. 什麼是 Google Kubernetes Engine（GKE）？
```
GKE 是 Google Cloud 提供的受管 Kubernetes 平台，讓您能夠在雲端部署、管理和擴展容器化應用程式。它支援兩種操作模式：
Standard 模式：您可以自行管理節點池，選擇節點的配置和數量。
Autopilot 模式：GKE 自動為您管理節點和資源配置，讓您專注於應用程式的部署。
GKE 簡化了 Kubernetes 的部署和維護，適合希望專注於應用程式開發而不想處理基礎設施管理的團隊。
```

3. GKE 中的節點池（Node Pool）有什麼作用？
```
在 GKE 中，節點池是一組具有相同配置的節點（虛擬機器），例如機器類型、磁碟大小和作業系統。每個節點池都使用 NodeConfig 規格來定義其配置。在 Standard 模式下，您可以根據工作負載的需求建立多個節點池，以實現更靈活的資源管理。在 Autopilot 模式下，GKE 會自動為您管理節點，無需手動配置節點池。 
Stack Overflow
Google Cloud
```

4. Kubernetes 叢集的控制平面由哪些元件組成？
```
Kubernetes 的控制平面負責管理叢集的整體狀態和協調。其主要元件包括：
kube-apiserver：叢集的主要 API 入口，處理所有的 REST 請求。
etcd：分散式鍵值存儲系統，保存叢集的所有配置數據。
kube-scheduler：負責將新建立的 Pod 分配到適當的節點上。
kube-controller-manager：運行各種控制器，確保叢集的實際狀態與期望狀態一致。
cloud-controller-manager：與雲端提供者的 API 互動，管理如負載平衡器和儲存卷等雲端資源。
這些元件協同工作，確保 Kubernetes 叢集的穩定運行和自動化管理。
```