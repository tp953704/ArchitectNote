# ğŸŒ GKE ç½‘ç»œç­–ç•¥å®æˆ˜å®Œå…¨æŒ‡å—ï¼ˆå°ç™½å‹å¥½ç‰ˆï¼‰

## ä¸€ã€å®éªŒç¯å¢ƒæ­å»º

### 1. åˆ›å»ºåŸºç¡€é›†ç¾¤
```bash
# è®¾ç½®è®¡ç®—åŒºåŸŸï¼ˆå°±åƒé€‰æ‹©æœºæˆ¿ä½ç½®ï¼‰
gcloud config set compute/zone us-west1-a

# åˆ›å»ºæ™®é€šé›†ç¾¤ï¼ˆé»˜è®¤å…³é—­ç½‘ç»œç­–ç•¥ï¼‰
gcloud container clusters create gke-deep-dive \
  --num-nodes=1 \
  --disk-type=pd-standard \
  --disk-size=10

# ä¸ºç°æœ‰é›†ç¾¤å¯ç”¨ç½‘ç»œç­–ç•¥ï¼ˆåƒæ‰“å¼€é˜²ç«å¢™åŠŸèƒ½ï¼‰
gcloud container clusters update gke-deep-dive \
  --enable-network-policy

# æˆ–è€…åˆ›å»ºæ—¶ç›´æ¥å¯ç”¨ï¼ˆæ¨èæ–°æ‰‹ç”¨è¿™ä¸ªï¼‰
gcloud container clusters create gke-deep-dive-network \
  --num-nodes=1 \
  --disk-type=pd-standard \
  --disk-size=10 \
  --enable-network-policy
```
### 2. éƒ¨ç½²æµ‹è¯•åº”ç”¨
```
# å¯åŠ¨ä¸€ä¸ª"Hello World"ç½‘é¡µæœåŠ¡ï¼ˆå°±åƒå¼€ä¸€å®¶å°åº—ï¼‰
kubectl run web-hello-world \
  --labels app=web-hello-world \
  --image=gcr.io/google-samples/hello-app:2.0 \
  --port 8080 \
  --expose  # è‡ªåŠ¨åˆ›å»ºå†…éƒ¨æœåŠ¡

# æ£€æŸ¥æœåŠ¡ï¼ˆç¡®è®¤æ²¡æœ‰å…¬ç½‘IPï¼Œåªåœ¨é›†ç¾¤å†…éƒ¨ï¼‰
kubectl get svc
```

## äºŒã€ç½‘ç»œç­–ç•¥å®æˆ˜
1. å…¥å£(Ingress)ç­–ç•¥ - "åº—é—¨ä¿å®‰"
```
# ingress.yaml - åªå…è®¸å¸¦"frontend"å·¥ä½œç‰Œçš„å®¢äººè¿›åº—
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: web-hello-world-ingress
spec:
  podSelector:
    matchLabels:
      app: web-hello-world  # é€‰æ‹©è¦ä¿æŠ¤çš„åº—é“º
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: frontend  # åªå…è®¸å‰ç«¯å‘˜å·¥è¿›å…¥
```
2. å‡ºå£(Egress)ç­–ç•¥ - "å‘˜å·¥å¤–å‡ºç®¡åˆ¶"
```
# egress.yaml - é™åˆ¶å‰ç«¯å‘˜å·¥èƒ½å»çš„åœ°æ–¹
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: web-hello-world-egress
spec:
  podSelector:
    matchLabels:
      app: frontend  # é’ˆå¯¹å‰ç«¯å‘˜å·¥
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: web-hello-world  # å…è®¸è®¿é—®Hello Worldåº—é“º
    - ports:  # å¿…é¡»å¼€æ”¾DNSç«¯å£ï¼ˆåƒå…è®¸æŸ¥ç”µè¯ç°¿ï¼‰
        - port: 53
          protocol: TCP
        - port: 53
          protocol: UDP
```
3. åº”ç”¨ç­–ç•¥
```
# éƒ¨ç½²ä¿å®‰ç³»ç»Ÿ
kubectl apply -f ingress.yaml
kubectl apply -f egress.yaml
```
## ä¸‰ã€æ•ˆæœéªŒè¯
1. æµ‹è¯•è®¿é—®æƒé™
```
æµ‹è¯•åœºæ™¯	å‰ç«¯Podæ‰§è¡Œ	åç«¯Podæ‰§è¡Œ	é¢„æœŸç»“æœ
è®¿é—®Hello World	curl http://web-hello-world:8080	åŒå·¦	å‰ç«¯âœ… åç«¯âŒ
è®¿é—®Google	curl google.com	åŒå·¦	å…¨éƒ¨âŒï¼ˆå› å‡ºå£ç­–ç•¥é™åˆ¶ï¼‰
ğŸ’¡ å®éªŒç°è±¡ï¼šå‰ç«¯Podèƒ½è®¿é—®æœåŠ¡ä½†æ— æ³•ä¸Šç½‘ï¼Œåç«¯Podå®Œå…¨è¢«é˜»æŒ¡
```
## å››ã€ç­–ç•¥è°ƒæ•´å®æˆ˜
1. ä¿®æ”¹å‡ºå£ç­–ç•¥ï¼ˆå®Œå…¨å°é”ï¼‰
```
# æ–°egress.yaml - è¿Hello Worldä¹Ÿä¸è®©è®¿é—®äº†
egress: []  # ç©ºè§„åˆ™ä»£è¡¨ç¦æ­¢æ‰€æœ‰å‡ºç«™
```
2. éªŒè¯æ•ˆæœ
```
# åœ¨å‰ç«¯Podä¸­æµ‹è¯•
curl http://web-hello-world:8080  # å¤±è´¥
curl google.com                   # å¤±è´¥
```
3. é€šè¿‡Service IPè®¿é—®ï¼ˆç‰¹æ®ŠæŠ€å·§ï¼‰
```
# è·å–Serviceçš„ClusterIP
kubectl get svc web-hello-world

# åœ¨å‰ç«¯Podä¸­ç”¨IPè®¿é—®ï¼ˆç»•è¿‡DNSé™åˆ¶ï¼‰
curl <service-ip>:8080
```
## äº”ã€æ•°æ®å®‰å…¨ä¸‰æ€è¯¦è§£
1. é™æ€æ•°æ®ï¼ˆç¡è§‰çš„æ•°æ®ï¼‰
```
ç‰¹ç‚¹	GKEä¿æŠ¤æªæ–½
å­˜å‚¨åœ¨ç£ç›˜ä¸Š	è‡ªåŠ¨AES-256åŠ å¯†
åŒ…æ‹¬å¤‡ä»½æ•°æ®	æ”¯æŒCloud KMSå®¢æˆ·è‡ªç®¡å¯†é’¥
ç±»ä¼¼"ä¼‘çœ çš„æ¡£æ¡ˆ"	è°·æ­Œç®¡ç†åº•å±‚åŠ å¯†
```
2. ä¼ è¾“ä¸­æ•°æ®ï¼ˆé£è¡Œä¸­çš„æ•°æ®ï¼‰
```
ç‰¹ç‚¹	GKEä¿æŠ¤æªæ–½
ç½‘ç»œä¼ è¾“ä¸­çš„æ•°æ®	å¼ºåˆ¶TLS 1.2+åŠ å¯†
åŒ…æ‹¬æ§åˆ¶å¹³é¢é€šä¿¡	ä½¿ç”¨BoringSSLåº“
ç±»ä¼¼"åŠ å¯†çš„å¿«é€’"	å‰å‘ä¿å¯†ä¿æŠ¤
```
3. ä½¿ç”¨ä¸­æ•°æ®ï¼ˆæ­£åœ¨å¤„ç†çš„æ•°æ®ï¼‰
```
ç‰¹ç‚¹	GKEä¿æŠ¤æªæ–½
å†…å­˜/CPUæ­£åœ¨å¤„ç†	ä¿å¯†è®¡ç®—æŠ€æœ¯ï¼ˆN2D/C2Dæœºå‹ï¼‰
æœ€æ˜“å—æ”»å‡»çŠ¶æ€	å†…å­˜æ•°æ®ä¹ŸåŠ å¯†
ç±»ä¼¼"é˜²å·çœ‹çš„åŠå…¬"	éœ€ç‰¹å®šåŒºåŸŸæ”¯æŒ
```
## å…­ã€æ¸…ç†ç¯å¢ƒ
```
# é€€å‡ºæµ‹è¯•Podï¼ˆä¼šè‡ªåŠ¨åˆ é™¤ï¼‰
exit

# åˆ é™¤æ•´ä¸ªé›†ç¾¤ï¼ˆå½»åº•æ‰“æ‰«ï¼‰
gcloud container clusters delete gke-deep-dive-network
```

## å­¦ä¹ è¦ç‚¹æ€»ç»“
- ç½‘ç»œç­–ç•¥æ˜¯ç™½åå• - é»˜è®¤æ‹’ç»æ‰€æœ‰ï¼Œå¿…é¡»æ˜ç¡®å…è®¸
- DNSç«¯å£(53)è¦ç‰¹æ®Šå¤„ç† - å¦åˆ™å†…éƒ¨æœåŠ¡åè§£æä¼šå¤±è´¥
- æ ‡ç­¾(Labels)æ˜¯å…³é”® - åƒå‘˜å·¥å·¥ç‰Œå†³å®šæƒé™
- ä¸‰ç§æ•°æ®çŠ¶æ€éœ€è¦ä¸åŒä¿æŠ¤ - é™æ€/ä¼ è¾“/ä½¿ç”¨ä¸­
- å…ˆæµ‹è¯•å†åº”ç”¨ - ä½¿ç”¨ä¸´æ—¶PodéªŒè¯ç­–ç•¥æ•ˆæœ