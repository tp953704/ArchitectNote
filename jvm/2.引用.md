# ğŸ“˜ Java â€” Escaping Referencesï¼ˆå¼•ç”¨æ´©æ¼ï¼‰ç­†è¨˜æ•´ç†

## ğŸ§© ä¸€ã€ä»€éº¼æ˜¯ Escaping Referenceï¼Ÿ

**Escaping Referenceï¼ˆå¼•ç”¨æ´©æ¼ï¼‰**ï¼š  
ç•¶ä¸€å€‹é¡åˆ¥å°‡å…§éƒ¨ç‰©ä»¶çš„åƒç…§ï¼ˆreferenceï¼‰æš´éœ²çµ¦å¤–éƒ¨ï¼Œä½¿å¤–éƒ¨ç¨‹å¼ç¢¼èƒ½å¤ ç›´æ¥ä¿®æ”¹å…§éƒ¨ç‹€æ…‹ï¼Œå°è‡´å°è£æ€§ï¼ˆencapsulationï¼‰è¢«ç ´å£ã€‚

### ç¯„ä¾‹ï¼š
```java
public class CustomerRecords {
    private Map<String, Customer> records = new HashMap<>();

    public Map<String, Customer> getCustomers() {
        return records; // âŒ æš´éœ²äº†å…§éƒ¨é›†åˆ
    }
}
```

å¤–éƒ¨ç¨‹å¼å¯ç›´æ¥ï¼š
```java
records.getCustomers().clear(); // æ¸…ç©ºå…§éƒ¨è³‡æ–™ï¼
```
é€™æ¨£å…§éƒ¨è³‡æ–™å°±ã€Œæ´©æ¼ã€å‡ºå»ï¼Œè¢«å¤–éƒ¨æ„å¤–æˆ–æƒ¡æ„ä¿®æ”¹ã€‚

## äºŒã€ç‚ºä½•é€™æ˜¯å•é¡Œï¼Ÿ
- ç ´å£ å°è£ï¼ˆEncapsulationï¼‰ åŸå‰‡
- é›£ä»¥è¿½è¹¤éŒ¯èª¤ï¼ˆç„¡æ³•çŸ¥é“å“ªè£¡æ”¹å£äº†è³‡æ–™ï¼‰
- å°è‡´ ä¸å¯é æœŸçš„å‰¯ä½œç”¨
- èˆ‡å…¶èªªæ˜¯èªæ³•éŒ¯èª¤ï¼Œä¸å¦‚èªªæ˜¯è¨­è¨ˆéŒ¯èª¤

## ä¸‰ã€å¸¸è¦‹è§£æ³•èˆ‡å…¶æ•ˆèƒ½å½±éŸ¿
âœ… 1ï¸âƒ£ å¯¦ä½œ Iterable ä»‹é¢
> ä½œæ³•ï¼šä¸å›å‚³é›†åˆï¼Œè€Œæ˜¯è®“é¡åˆ¥æœ¬èº«å¯è¢«è¿­ä»£ã€‚
```java
public class CustomerRecords implements Iterable<Customer> {
    private Map<String, Customer> records = new HashMap<>();

    @Override
    public Iterator<Customer> iterator() {
        return records.values().iterator();
    }
}
```
ä½¿ç”¨ç«¯ï¼š
```java
for (Customer c : records) {
    System.out.println(c);
}
```
å•é¡Œï¼š
ä»ç„¶å¯ä»¥é€é iterator.remove() ä¿®æ”¹é›†åˆ â†’ éå®Œå…¨é˜²è­·
æ•ˆèƒ½å½±éŸ¿ï¼š
ğŸš€ é›¶æ€§èƒ½å½±éŸ¿ï¼ˆZero Performance Impactï¼‰

âœ… 2ï¸âƒ£ å›å‚³é›†åˆçš„è¤‡æœ¬ï¼ˆCopy Collectionï¼‰
ä½œæ³•ï¼š
```
public Map<String, Customer> getCustomers() {
    return new HashMap<>(records); // å›å‚³è¤‡æœ¬
}
```
ç‰¹é»ï¼š
å¤–éƒ¨å¯æ”¹å‹•è¤‡æœ¬ï¼Œä½†ä¸å½±éŸ¿åŸå§‹è³‡æ–™ã€‚
ä»å¯ä¿®æ”¹ç‰©ä»¶æœ¬èº«ï¼ˆè‹¥ç‰©ä»¶ç‚ºå¯è®Šï¼‰ã€‚

æ•ˆèƒ½å½±éŸ¿ï¼š
å°å¹…çš„æ™‚é–“èˆ‡è¨˜æ†¶é«”é–‹éŠ·ï¼ˆè¤‡è£½ references è€Œéæ•´å€‹ç‰©ä»¶ï¼‰
ç´„ç‚ºæ¯ç­†è³‡æ–™ 8 bytes Ã— N ç­†
å°æ•ˆèƒ½å½±éŸ¿æ¥µä½ï¼Œä¸”è¨˜æ†¶é«”å¾ˆå¿«è¢« GC å›æ”¶ã€‚

âœ… 3ï¸âƒ£ å›å‚³ã€Œä¸å¯è®Šé›†åˆï¼ˆImmutable Collectionï¼‰ã€
Java 8 å¯«æ³•ï¼š
```
return Collections.unmodifiableMap(records);
```
Java 10+ å¯«æ³•ï¼š
```
return Map.copyOf(records);
```
æ•ˆæœï¼š
å¤–éƒ¨å‘¼å« clear()ã€put() æ™‚æœƒæ‹‹å‡ºï¼šUnsupportedOperationException


ğŸ”’ å®Œå…¨é˜»æ­¢é›†åˆè¢«ä¿®æ”¹
æ•ˆèƒ½å½±éŸ¿ï¼š
å¹¾ä¹èˆ‡ Copy ç›¸åŒ
Java 10+ å¯«æ³•è‹¥åŸæœ¬å·²æ˜¯ä¸å¯è®Šé›†åˆï¼Œå‰‡ä¸æœƒæ–°å»ºè¤‡æœ¬ â†’ æ›´å¿«

âœ… 4ï¸âƒ£ å›å‚³ç‰©ä»¶çš„è¤‡æœ¬ï¼ˆCopy Constructorï¼‰

ç•¶å–®ä¸€ç‰©ä»¶è¢«å›å‚³æ™‚ä¹Ÿå¯èƒ½ç™¼ç”Ÿå¼•ç”¨æ´©æ¼ï¼š
```
public Customer find(String name) {
    return records.get(name); // âŒ æš´éœ²å…§éƒ¨ç‰©ä»¶
}
```
æ”¹è‰¯ï¼šè¤‡è£½ç‰©ä»¶
```
public class Customer {
    private String name;
    public Customer(Customer other) {
        this.name = other.name;
    }
}

public Customer find(String name) {
    return new Customer(records.get(name)); // âœ… æ–°çš„å¯¦é«”
}
```

æ•ˆèƒ½å½±éŸ¿ï¼š
éœ€è¦é¡å¤–å»ºç«‹æ–°ç‰©ä»¶ï¼ˆè¤‡è£½ fieldsï¼‰
ä½†æˆæœ¬æ¥µä½ï¼Œä¸”ç‰©ä»¶çŸ­å‘½ï¼ŒGC æ•ˆç‡é«˜

âœ… 5ï¸âƒ£ å›å‚³ã€Œå”¯è®€ä»‹é¢ï¼ˆRead-only Interfaceï¼‰ã€

æ ¸å¿ƒæ¦‚å¿µï¼š
é€éä»‹é¢è®“å¤–éƒ¨åªèƒ½è®€å–ï¼Œä¸èƒ½ä¿®æ”¹ã€‚
```
public interface ReadOnlyCustomer {
    String getName();
    String toString();
}

public class Customer implements ReadOnlyCustomer {
    private String name;
    public void setName(String name) { this.name = name; }
}

public ReadOnlyCustomer find(String name) {
    return records.get(name);
}
```

æ•ˆæœï¼š
ç·¨è­¯æœŸå³é˜»æ­¢å‘¼å« setName()
è‹¥å˜—è©¦è½‰å‹ (Customer)c ä¹Ÿä¸æœƒå½±éŸ¿åŸå§‹è³‡æ–™

æ•ˆèƒ½å½±éŸ¿ï¼š
å¹¾ä¹ç‚ºé›¶ï¼Œåƒ…å¢åŠ ä»‹é¢å‘¼å«é–‹éŠ·ï¼ˆæ¥µå°ï¼‰

âœ… 6ï¸âƒ£ ä½¿ç”¨ Java 9+ æ¨¡çµ„ç³»çµ±ï¼ˆModule Systemï¼‰

ä½œæ³•ï¼š
åœ¨ module-info.java ä¸­åª exports å…¬é–‹çš„å°è£ï¼š
```
module escaping.references {
    exports com.vpp.escapingreferences.customers;
}
åªå…¬é–‹ä»‹é¢èˆ‡ç®¡ç†é¡ï¼Œéš±è—å¯¦ä½œé¡
com.vpp.escapingreferences.customers
 â”œâ”€â”€ ReadOnlyCustomer.java âœ… exported
 â”œâ”€â”€ CustomerRecords.java âœ… exported
 â””â”€â”€ implementation/
      â””â”€â”€ Customer.java âŒ hidden
```

å¤–éƒ¨æ¨¡çµ„ç„¡æ³•å­˜å– Customer é¡åˆ¥ï¼Œä¹Ÿç„¡æ³•é€éè½‰å‹ç ´å£å°è£ã€‚

æ•ˆèƒ½å½±éŸ¿ï¼š
ç„¡æ€§èƒ½æè€—ï¼Œå®Œå…¨å±¬æ–¼è¨­è¨ˆå±¤é¢çš„å°è£æ©Ÿåˆ¶ã€‚

## Java è¨˜æ†¶é«”é‹ä½œèˆ‡ Meta Space ç­†è¨˜
### Java è¨˜æ†¶é«”ä¸‰å¤§å€åŸŸ
- Java çš„è¨˜æ†¶é«”ä¸»è¦åˆ†ç‚ºä¸‰å€‹éƒ¨åˆ†ï¼š
    1. Stackï¼ˆå †ç–Šï¼‰
    2. Heapï¼ˆå †ï¼‰
    3. Meta Spaceï¼ˆä¸­ç¹¼ç©ºé–“ï¼‰
> è¨»ï¼šé€™ä¸‰è€…çš„æ¯”ä¾‹åœ–ä¸¦ä¸ä»£è¡¨å¯¦éš›å¤§å°ã€‚ä¸€èˆ¬è€Œè¨€ï¼ŒHeap é€šå¸¸éå¸¸å¤§ï¼Œè€Œ Stack èˆ‡ Meta Space ç›¸å°å°å¾—å¤šã€‚

### Meta Spaceï¼ˆä¸­ç¹¼ç©ºé–“ï¼‰
#### ä¸»è¦ç”¨é€”
- Meta Space ä¸»è¦å„²å­˜ï¼š
    1. é¡åˆ¥ï¼ˆClassï¼‰èˆ‡æ–¹æ³•ï¼ˆMethodï¼‰çš„ä¸­ç¹¼è³‡æ–™ï¼ˆmetadataï¼‰
    2. å“ªäº›æ–¹æ³•å·²è¢«ç·¨è­¯ç‚º bytecode æˆ– native code
#### éœæ…‹è®Šæ•¸ï¼ˆStatic Variablesï¼‰
    - éœæ…‹åŸå§‹å‹åˆ¥ï¼ˆstatic primitivesï¼‰ï¼šå®Œå…¨å„²å­˜åœ¨ Meta Space ä¸­ã€‚
    - éœæ…‹ç‰©ä»¶ï¼ˆstatic objectsï¼‰ï¼šç‰©ä»¶æœ¬èº«å­˜åœ¨ Heapï¼Œä½†å…¶åƒè€ƒï¼ˆreferenceï¼‰å„²å­˜åœ¨ Meta Spaceã€‚
```
static int globalVersion; // å„²å­˜åœ¨ Meta Space
static Map<String, String> settings = new HashMap<>(); // åƒè€ƒå­˜åœ¨ Meta Spaceï¼Œç‰©ä»¶å­˜åœ¨ Heap
```
#### è®Šæ•¸ç”Ÿå‘½é€±æœŸ
- Stack è®Šæ•¸æœƒåœ¨é›¢é–‹ä½œç”¨åŸŸï¼ˆscopeï¼‰æ™‚è¢«é‡‹æ”¾ã€‚
- Meta Space çš„éœæ…‹è®Šæ•¸å‰‡æ°¸ä¹…å­˜åœ¨ï¼Œä¸æœƒè¢«å›æ”¶ã€‚
- ä»»ä½•è¢« Meta Space å¼•ç”¨çš„ç‰©ä»¶ï¼Œä¸æœƒè¢«åƒåœ¾å›æ”¶ï¼ˆGCï¼‰ã€‚

#### å¯è¦‹æ€§
- æ‰€æœ‰åŸ·è¡Œç·’èˆ‡é¡åˆ¥çš†å¯å­˜å– Meta Spaceã€‚
- å› æ­¤éœæ…‹è®Šæ•¸èƒ½è¢«å…¨åŸŸè¨ªå•ã€‚

#### Public vs Private
- public èˆ‡ private åƒ…å½±éŸ¿å¯è¦‹æ€§ï¼Œä¸å½±éŸ¿è®Šæ•¸çš„å„²å­˜ä½ç½®ã€‚
- å³ä½¿æ˜¯ public ç‰©ä»¶è®Šæ•¸ï¼Œå…¶å€¼ä»å„²å­˜åœ¨ Heapã€‚
```
public class Customer {
    public String name;
}

Customer c = new Customer();
c.name = "John"; // name ä»åœ¨ Heap ä¸­
```
#### PermGen vs Meta Space
- Java 8 ä»¥å‰ä½¿ç”¨ PermGenï¼ˆæ°¸ä¹…ä»£ï¼‰ã€‚
- Java 8 ä¹‹å¾Œæ”¹ç‚º Meta Spaceã€‚
- èˆŠåƒæ•¸å¦‚ -XX:PermSizeã€-XX:MaxPermSize å·²è¢«æ£„ç”¨ã€‚
> è‹¥å‡ç´š JVM è‡³ Java 8 æˆ–ä»¥ä¸Šç‰ˆæœ¬æ™‚ä»ä¿ç•™é€™äº›åƒæ•¸ï¼Œæœƒçœ‹åˆ°ã€Œinvalid flagsã€è­¦å‘Šä½†ä¸æœƒå ±éŒ¯ã€‚

### Stack èˆ‡ Heap çš„å·®ç•°
#### Stack
- ç®¡ç†æ•ˆç‡é«˜ã€‚
- ç•¶ä½œç”¨åŸŸçµæŸæ™‚ï¼Œè®Šæ•¸ç«‹å³é‡‹æ”¾ã€‚
- åƒ…å„²å­˜åŸå§‹å‹åˆ¥å€¼èˆ‡ç‰©ä»¶åƒè€ƒï¼ˆreferenceï¼‰ã€‚
#### Heap
- å„²å­˜ç‰©ä»¶å¯¦é«”ï¼ˆobjectsï¼‰ã€‚
- ç”Ÿå‘½é€±æœŸé•·ã€å¤§å°è®Šå‹•å¤§ã€‚
- åƒåœ¾å›æ”¶ï¼ˆGCï¼‰æœƒå®šæœŸæ¸…ç†ä¸å†è¢«å¼•ç”¨çš„ç‰©ä»¶ã€‚

#### ç‚ºä»€éº¼ Java ä¸è®“æˆ‘å€‘æ±ºå®šå„²å­˜ä½ç½®ï¼Ÿ
- Java è¨­è¨ˆç†å¿µï¼šç°¡åŒ–ç¨‹å¼è¨­è¨ˆå¸«çš„æ±ºç­–ã€‚
- æ‰€æœ‰ç‰©ä»¶ä¸€å¾‹æ”¾åœ¨ Heapã€‚
- ä¸é JVM æœƒè‡ªå‹•æœ€ä½³åŒ–ï¼Œå¦‚æœåµæ¸¬åˆ°ç‰©ä»¶åªåœ¨å€åŸŸç¯„åœå…§ä½¿ç”¨ï¼Œä¸æœƒå¤–éƒ¨å¼•ç”¨ï¼ŒJVM å¯èƒ½ç›´æ¥æŠŠå®ƒå»ºç«‹åœ¨ Stack ä¸Šä»¥æå‡æ•ˆèƒ½ã€‚

### å­—ä¸²ï¼ˆStringï¼‰æœ€ä½³åŒ–
#### å­—ä¸²æ± ï¼ˆString Poolï¼‰
- å› ç‚ºå­—ä¸²æ˜¯**ä¸å¯è®Šï¼ˆimmutableï¼‰**çš„ï¼ŒJVM å¯ä»¥å®‰å…¨åœ°é‡è¤‡ä½¿ç”¨ç›¸åŒå…§å®¹çš„å­—ä¸²ã€‚
- ç•¶å»ºç«‹å­—ä¸²æ™‚ï¼Œè‹¥å…§å®¹ç›¸åŒï¼ŒæœƒæŒ‡å‘åŒä¸€å€‹ Heap ç‰©ä»¶ã€‚
```
String one = "hello";
String two = "hello";
System.out.println(one == two); // true â†’ å…©è€…æŒ‡å‘ç›¸åŒç‰©ä»¶
```
- è¨ˆç®—å¾—ä¾†çš„å­—ä¸²ä¸æœƒè‡ªå‹•é€²å…¥å­—ä¸²æ± 
```
Integer i = 76;
String s1 = i.toString(); // æœªé€²å…¥æ± 
String s2 = "76";
System.out.println(s1 == s2); // false
```
- ä½¿ç”¨ intern() å¼·åˆ¶æ”¾å…¥å­—ä¸²æ± 
```
String s1 = i.toString().intern();
String s2 = "76";
System.out.println(s1 == s2); // true
```
- ç‚ºä½•ä½¿ç”¨ intern()ï¼Ÿ
    1. å¯ç¯€çœè¨˜æ†¶é«”ï¼Œæ¸›å°‘é‡è¤‡å­—ä¸²ç‰©ä»¶ã€‚
    2. é©ç”¨æ–¼é‡è¤‡ä½¿ç”¨çš„å­—ä¸²ï¼ˆä¾‹å¦‚å¸¸è¦‹ä»£ç¢¼ã€IDã€ç‹€æ…‹å­—ï¼‰ã€‚

> ç¼ºé»ï¼šintern() æœ¬èº«éœ€è¦é¡å¤–é‹ç®—æ™‚é–“ã€‚

#### å­—ä¸²æ± ä½ç½®è®ŠåŒ–
- Java 6 ä»¥å‰ï¼šå­—ä¸²æ± åœ¨ PermGenã€‚
- Java 7 ä»¥å¾Œï¼šå­—ä¸²æ± ç§»åˆ° Heapã€‚
    - ä»£è¡¨å­—ä¸²æ± ä¸­çš„å­—ä¸²ä¹Ÿå¯è¢« GC å›æ”¶ã€‚
#### JVM çš„æœ€ä½³åŒ–è¡Œç‚º
- é€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰ï¼šåˆ¤æ–·ç‰©ä»¶æ˜¯å¦åƒ…åœ¨å€åŸŸå…§ä½¿ç”¨ã€‚
    - è‹¥æ˜¯ï¼Œå‰‡å¯åœ¨ Stack ä¸Šå»ºç«‹ï¼Œæå‡æ•ˆèƒ½ã€‚
- å­—ä¸²å»é‡ï¼ˆString Deduplicationï¼‰ï¼šJVM å¯èƒ½ä¸»å‹•åˆä½µé‡è¤‡å­—ä¸²ã€‚

# ç¬¬åç« ï¼šJVM è¨˜æ†¶é«”æ——æ¨™èª¿æ ¡ï¼ˆMemory Tuning Flagsï¼‰

## æœ¬ç« å°è¨€

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ¢è¨å¹¾å€‹å¯ç”¨ä¾†**èª¿æ•´ JVM è¨˜æ†¶é«”è¨­å®š**çš„æ——æ¨™ï¼ˆflagsï¼‰ï¼Œä»¥å„ªåŒ–æ‡‰ç”¨ç¨‹å¼åœ¨åŸ·è¡ŒæœŸé–“çš„æ•ˆèƒ½ã€‚

æœ¬ç« å¾ä¸Šä¸€ç« çš„ **String Poolï¼ˆå­—ä¸²æ± ï¼‰** å»¶ä¼¸ï¼Œèªªæ˜å…¶å¯¦ä½œåŸç†èˆ‡èª¿æ ¡æ–¹æ³•ï¼Œä¸¦ä»‹ç´¹å¦‚ä½•åˆ©ç”¨ JVM æ——æ¨™è§€å¯Ÿèˆ‡æ”¹å–„è¨˜æ†¶é«”é…ç½®ã€‚

---

### ä¸€ã€String Pool èˆ‡ HashMap çš„é—œä¿‚

Java çš„å­—ä¸²æ± ï¼ˆString Poolï¼‰æ˜¯åˆ©ç”¨ **HashMap** çš„æ¦‚å¿µå¯¦ä½œçš„ã€‚

- å¯ä»¥æƒ³åƒå­—ä¸²æ± æ˜¯ä¸€çµ„ **æ¡¶ï¼ˆbucketsï¼‰**ã€‚
- æ¯å€‹å­—ä¸²æ ¹æ“šå®ƒçš„ **hash codeï¼ˆé›œæ¹Šç¢¼ï¼‰** è¢«æ”¾å…¥ç‰¹å®šçš„ bucketã€‚
- è‹¥å¤šå€‹å­—ä¸²çš„ hash code ç›¸åŒï¼Œå®ƒå€‘æœƒå­˜åœ¨åŒä¸€å€‹ bucketã€‚

ä¾‹å¦‚ï¼š
- `"mouse"` â†’ bucket #5  
- `"book"` â†’ bucket #9  
- `"chair"` â†’ bucket #5  

é›–ç„¶ `"chair"` å’Œ `"mouse"` æ˜¯ä¸åŒå­—ä¸²ï¼Œä½†å¯èƒ½æœƒé€²å…¥ç›¸åŒçš„ bucketã€‚

---

### äºŒã€ç‚ºä½•éœ€è¦ä½¿ç”¨é›œæ¹Šæ¡¶ï¼ˆBucketsï¼‰

é€™ç¨®åˆ†æ¡¶è¨­è¨ˆèƒ½è®“æœå°‹èˆ‡æ–°å¢å­—ä¸²çš„æ•ˆç‡æ›´é«˜ï¼š

- ç•¶æ–°å¢æ–°å­—ä¸²æ™‚ï¼ŒJVM åªéœ€æª¢æŸ¥è©²å­—ä¸²æ‰€å±¬ bucketï¼Œè€Œä¸å¿…éæ­·æ•´å€‹æ± ã€‚
- è‹¥å­—ä¸²å·²å­˜åœ¨æ–¼è©² bucketï¼Œå‰‡ç›´æ¥é‡ç”¨ç¾æœ‰å­—ä¸²ï¼ˆinternï¼‰ã€‚
- è‹¥ä¸å­˜åœ¨ï¼Œå‰‡æ–°å¢ã€‚

ğŸ’¡ **æ•ˆèƒ½å–æ±ºæ–¼ bucket çš„æ•¸é‡ï¼š**
- è‹¥ bucket éå°‘ â†’ æ¯å€‹ bucket å¤ªæ“æ“ ï¼Œæœå°‹æ•ˆç‡ä¸‹é™ã€‚
- è‹¥ bucket éå¤š â†’ é›–ç„¶æµªè²»è¨˜æ†¶é«”ï¼Œä½†æ•ˆèƒ½ä¸å—æ˜é¡¯å½±éŸ¿ã€‚

---

### ä¸‰ã€æª¢è¦–å­—ä¸²æ± çµ±è¨ˆè³‡è¨Š

ä½¿ç”¨ä»¥ä¸‹ JVM æ——æ¨™ï¼š

```bash
-XX:+PrintStringTableStatistics
```
å¯è¼¸å‡º JVM ç›®å‰å­—ä¸²æ± çš„çµ±è¨ˆæ•¸æ“šï¼š
1. bucket ç¸½æ•¸
2. å­—ä¸²ç¸½æ•¸
3. æ¯å€‹ bucket çš„å¹³å‡å­—ä¸²æ•¸é‡
4. æœ€å¤§ bucket çš„å­—ä¸²æ•¸
5. ç¸½è¨˜æ†¶é«”ä½”ç”¨ï¼ˆfootprintï¼‰

### å››ã€ç‰ˆæœ¬ç›¸å®¹æ€§å•é¡Œ
- Java 11ï¼ˆOpenJDKï¼‰ ä½¿ç”¨è©²æ——æ¨™æœƒå°è‡´ fatal errorã€‚
- Java 8 åŠ Java 12 ä»¥ä¸Šç‰ˆæœ¬ é‹ä½œæ­£å¸¸ã€‚
> âœ… å»ºè­°ä½¿ç”¨ Java 8 æˆ– 12+ åŸ·è¡Œè©²æ——æ¨™ã€‚

### äº”ã€å­—ä¸²æ± çš„é è¨­å¤§å°
- ä»¥ Java 8 èµ·ç‚ºä¾‹ï¼š
    1. é è¨­ bucket æ•¸ï¼š60,013
    2. JVM å•Ÿå‹•å¾Œï¼Œå³ä¾¿ç¨‹å¼ç©ºç™½ï¼Œä¹Ÿæœƒè‡ªå‹•è¼‰å…¥ç´„ 731 å€‹å­—ä¸²ï¼ˆåŒ…æ‹¬å…§éƒ¨ä½¿ç”¨çš„å¸¸ç”¨å­—ä¸²èˆ‡ç©ºå­—ä¸²ï¼‰
### å…­ã€å¯¦é©—ï¼šå»ºç«‹å¤§é‡å­—ä¸²è§€å¯Ÿæ•ˆèƒ½
```
List<String> strings = new ArrayList<>();

for (int i = 1; i < 10_000_000; i++) {
    String s = Integer.toString(i).intern();
    strings.add(s);
}
```
æ­¤ç¨‹å¼æœƒç”¢ç”Ÿç´„ 1,000 è¬å€‹å­—ä¸² ä¸¦æ”¾å…¥å­—ä¸²æ± ã€‚

- åŸ·è¡Œçµæœï¼ˆé è¨­ 60,013 bucketsï¼‰
    1. åŸ·è¡Œæ™‚é–“ï¼šç´„ 49 ç§’
    2. å¹³å‡æ¯ bucket å« 166 å€‹å­—ä¸²
    3. æœ€å¤§ bucket å« 196 å€‹å­—ä¸²
    4. å­—ä¸²æ± ç¸½ä½”ç”¨ç´„ 800 MB

### ä¸ƒã€å„ªåŒ–ï¼šå¢åŠ  String Pool å¤§å°
å¯ä½¿ç”¨ä»¥ä¸‹æ——æ¨™èª¿æ•´å­—ä¸²æ± çš„ bucket æ•¸ï¼š
```
-XX:StringTableSize=120121
```
### å…«ã€Heapï¼ˆå †ï¼‰è¨˜æ†¶é«”èˆ‡å­—ä¸²æ± çš„é—œä¿‚
> è‡ª Java 8 èµ·ï¼šString Pool ä½æ–¼ Heapï¼ˆå †è¨˜æ†¶é«”ï¼‰ å…§éƒ¨ã€‚å› æ­¤ï¼ŒHeap çš„å¤§å°å¿…é ˆè¶³ä»¥å®¹ç´å­—ä¸²æ± èˆ‡å…¶ä»–ç‰©ä»¶ã€‚
### ä¹ã€æª¢è¦– Heap å¤§å°è¨­å®š
```
-XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal
```
é‡é»æ¬„ä½ï¼š
- InitialHeapSizeï¼ˆåˆå§‹å †å¤§å°ï¼‰
- MaxHeapSizeï¼ˆæœ€å¤§å †å¤§å°ï¼‰

ç¯„ä¾‹çµæœï¼š
- InitialHeapSize â‰ˆ 260MB
- MaxHeapSize â‰ˆ 4GB

### åã€è¨­å®š Heap å¤§å°
- 1ï¸âƒ£ é™åˆ¶æœ€å¤§ Heap å¤§å°
```
-XX:MaxHeapSize=600m
```
- è‹¥è¨­å®šéå°ï¼Œæœƒå‡ºç¾ï¼š
```
java.lang.OutOfMemoryError: Java heap space
```

âš ï¸ æ³¨æ„ï¼š
> å‡ºç¾ OOMï¼ˆOutOfMemoryErrorï¼‰æ™‚ï¼Œä¸è¦ç›´æ¥å¢å¤§ Heapã€‚æ‡‰å…ˆç¢ºèªæ˜¯å¦æœ‰ Memory Leakï¼ˆè¨˜æ†¶é«”æ´©æ¼ï¼‰ã€‚
- 2ï¸âƒ£ è¨­å®šåˆå§‹ Heap å¤§å°
```
-XX:InitialHeapSize=1g
```
è®“æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚å°±æ“æœ‰è¶³å¤ çš„è¨˜æ†¶é«”ç©ºé–“ï¼Œå¯æ¸›å°‘æ“´å®¹èˆ‡ GC è² æ“”ã€‚

æ•ˆæœæ¯”è¼ƒï¼š
```
è¨­å®š	åŸ·è¡Œæ™‚é–“
é è¨­	28 ç§’
-XX:InitialHeapSize=1g	23.5 ç§’ âœ…
# æå‡ç´„ 15~20% æ•ˆèƒ½ã€‚
```

### åä¸€ã€æ——æ¨™ç°¡å¯«èªæ³•
```
å®Œæ•´èªæ³•	ç°¡å¯«èªæ³•	ç”¨é€”
-XX:InitialHeapSize=	-Xms	è¨­å®šåˆå§‹ Heap
-XX:MaxHeapSize=	-Xmx	è¨­å®šæœ€å¤§ Heap
```
ç¯„ä¾‹ï¼š
```
java -Xms1g -Xmx2g -XX:StringTableSize=120121 -XX:+PrintStringTableStatistics Main
```
### åäºŒã€ç¸½æ•´ç†ï¼šæœ¬ç«  JVM æ——æ¨™

| åŠŸèƒ½      | æ——æ¨™                                                    | èªªæ˜                |
| ------- | ----------------------------------------------------- | ----------------- |
| æª¢è¦–å­—ä¸²æ± çµ±è¨ˆ | `-XX:+PrintStringTableStatistics`                     | é¡¯ç¤º bucket åˆ†ä½ˆèˆ‡å¯†åº¦   |
| èª¿æ•´å­—ä¸²æ± å¤§å° | `-XX:StringTableSize=<prime>`                         | è¨­å®š String Pool æ¡¶æ•¸ |
| æœ€å¤§å †å¤§å°   | `-Xmx<size>`                                          | é™åˆ¶ JVM å¯ç”¨æœ€å¤§ Heap  |
| åˆå§‹å †å¤§å°   | `-Xms<size>`                                          | å•Ÿå‹•æ™‚åˆ†é… Heap å¤§å°     |
| æª¢è¦–æ‰€æœ‰è¨­å®š  | `-XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal` | åˆ—å‡º JVM åƒæ•¸         |

### åä¸‰ã€æ•ˆèƒ½æ¸¬è©¦ç¸½è¦½
| æ¸¬è©¦é …ç›®                      | å¹³å‡ Bucket å­—ä¸²æ•¸ | åŸ·è¡Œæ™‚é–“       | Heap ä½¿ç”¨é‡ |
| ------------------------- | ------------- | ---------- | -------- |
| é è¨­ï¼ˆ60,013ï¼‰                | 166           | 49 ç§’       | 800 MB   |
| èª¿æ•´ StringTableSize=120121 | 83            | 28 ç§’       | 800.9 MB |
| åŠ å¤§ InitialHeapSize=1G     | 83            | **23.5 ç§’** | 801 MB   |
