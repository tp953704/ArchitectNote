# Kubernetes 平台二进制文件验证指南

## 验证的重要性
- 防止下载被篡改的恶意二进制文件
- 确保文件完整性（任何微小改动都会导致哈希值完全不同）
- 保护集群部署前的安全基础

## 验证步骤
1. **获取官方哈希值**
   - 从 [Kubernetes GitHub 发布页面](https://github.com/kubernetes/kubernetes/releases) 获取官方校验和

2. **下载二进制文件**
   ```bash
   curl -LO [二进制文件URL]
   ```
3. 生成本地哈希值
    - macOS:
    ```
    shasum -a 512 [文件名]  # 生成512位哈希
    shasum -a 256 [文件名]  # 生成256位哈希
    ```
    - Linux:
    ```
    sha512sum [文件名]  # 推荐方式
    sha256sum [文件名]
    ```
4. 对比哈希值
    - 将生成的哈希值与官方发布页面的哈希值逐字符对比
    - 必须完全一致

## 安全注意事项
⚠️ 所有通过网络下载的文件都应验证
⚠️ 哈希值不匹配应立即删除文件并重新下载
⚠️ 建议通过HTTPS下载确保传输安全

# Kubernetes 集群升级指南

## 核心版本兼容规则
| 组件                | 允许版本偏差          | 示例 (API Server=1.10) |
|---------------------|-----------------------|------------------------|
| kube-apiserver      | 基准版本 (x)          | 1.10                   |
| 控制器管理器/调度器 | x 或 x-1              | 1.10 或 1.9            |
| kubelet/kube-proxy  | x, x-1 或 x-2         | 1.8 - 1.10             |
| kubectl             | x, x-1 或 x+1         | 1.9 - 1.11             |

## 升级时机策略
- **版本支持窗口**：K8s仅维护最近3个小版本
  ```mermaid
  timeline
    title 版本支持示例
    1.10 : 活跃
    1.11 : 活跃
    1.12 : 最新发布
    1.13 : 发布后1.10将淘汰
  最佳升级时机：新版本发布前（如1.13发布前升级1.10→1.12）
  ```
## 升级路径原则
- 禁止跨版本升级：必须逐步升级（1.10 → 1.11 → 1.12 → 1.13）
- 升级顺序：
    1. 控制平面（Master节点）
    2. 工作节点（Worker节点）

## 控制平面升级流程
1. 前置检查
    ```
    kubeadm upgrade plan
    # 输出包含：
    # - 当前版本状态
    # - 可升级目标版本
    # - 需手动升级的组件列表
    ```
2. 执行升级
```
# 先升级kubeadm工具本身
apt-get upgrade -y kubeadm=1.12.0-00

# 再升级集群
kubeadm upgrade apply v1.12.0
```
3. 节点组件升级
```
# 升级kubelet（如有）
apt-get upgrade -y kubelet=1.12.0-00
systemctl restart kubelet
```
## 工作节点升级策略
```
策略	影响	适用场景
全量停机升级	服务完全中断	非生产环境
滚动升级（推荐）	逐个节点维护	生产环境
蓝绿部署	新增节点替换旧节点	云环境/有弹性伸缩能力
``` 
### 滚动升级实操步骤
1. 隔离节点
    ```
    kubectl drain <node> --ignore-daemonsets
    ```
    - 驱逐Pod到其他节点
    - 标记节点为不可调度
2. 执行升级
    ```
    apt-get upgrade -y kubeadm kubelet
    kubeadm upgrade node
    systemctl restart kubelet
    ```
3. 恢复节点
    ```
    kubectl uncordon <node>
    ```
### 升级影响说明
- 控制平面停机：
    - 管理功能暂停（kubectl不可用）
    - 现有工作负载继续运行
    - 自动修复功能暂停（如Pod崩溃不会重建）
- 工作节点升级：
    - 每个节点升级时其Pod会迁移
    - 需确保集群有足够冗余资源
### 特殊注意事项
- etcd/CoreDNS：需单独考虑版本兼容性
- 云托管集群：可能提供一键升级功能（如GKE）
- 证书有效期：升级可能触发证书轮换