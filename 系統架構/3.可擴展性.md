# 系統擴展技術詳細筆記：複製（Replication）

## 📊 系統擴展架構概述

### 初始架構
- Web應用層：1個實例
- 服務層：1個實例  
- 數據庫層：1個實例

### 擴展後架構
- Web應用層：3個實例（相同代碼）
- 服務層：3個實例（相同代碼）
- 數據庫層：2個數據庫（數據複製）

## 🔄 複製類型

### 無狀態複製（Stateless Replication）
- **特徵**：僅複製代碼，不存儲數據
- **應用場景**：業務應用層、服務層
- **數據生命周期**：僅在請求期間存在，請求結束後消失
- **優點**：簡單、易擴展

### 有狀態複製（Stateful Replication）
- **特徵**：複製代碼和數據
- **應用場景**：數據庫層、特定Web應用場景
- **數據持久性**：數據在實例內存中持久存儲
- **挑戰**：數據一致性、故障恢復

## 🌐 Web層複製策略

### 有狀態Web複製
#### 實現機制
- **粘性會話（Sticky Sessions）**
  - 首次請求時在特定節點創建會話並存儲用戶數據
  - 通過Cookie記錄會話ID和節點信息
  - 後續請求通過負載均衡器路由到同一節點

#### 優點
- **低延遲**：後續請求直接從內存讀取，無需訪問數據庫
- **性能提升**：消除服務層和數據庫層的調用開銷

#### 局限性
##### 可擴展性限制
- 內存限制：每個會話佔用內存，限制並發連接數
- 資源浪費：需要更多機器來支持相同數量的用戶

##### 可靠性問題
- **節點故障**：節點宕機導致會話數據丟失
- **數據不一致**：會話中的修改未同步到數據庫
- **臨時高延遲**：故障後需要重新從數據庫加載數據

#### 集群會話解決方案
- WebLogic、WebSphere等提供的集群會話功能
- 會話數據在多個節點間複製
- 複雜性高，不是首選方案

### 無狀態Web複製
#### 架構改進
- **共享緩存**：使用Memcached、Redis存儲會話數據
- **客戶端存儲**：小量數據存儲在Cookie中

#### 工作流程
1. 首次請求：從數據庫獲取數據，存入共享緩存
2. 後續請求：從任何節點訪問共享緩存獲取數據
3. 緩存故障：重新從數據庫加載並重建緩存

#### 優點
- **高可擴展性**：不受單節點內存限制
- **高可靠性**：節點故障不影響數據可用性
- **性能平衡**：通過緩存減少數據庫訪問延遲

#### 適用場景
- 大多數Web應用場景
- 需要高可擴展性的系統

## ⚙️ 服務層複製

### 複製策略
- 主要採用無狀態複製
- 可選共享緩存減少數據庫訪問

### 特殊考慮
#### 共享資源同步
- **問題**：多實例訪問共享文件時的同步問題
- **解決方案**：
  - 傳統線程同步機制失效
  - 使用數據庫鎖表實現分佈式鎖
  - 基於數據庫行鎖協調文件訪問

## 🗄️ 數據庫複製

### 複製配置類型

#### 主從複製（Master-Slave）
##### 架構特點
- **主數據庫**：處理讀寫請求
- **從數據庫**：僅處理讀請求
- **複製方向**：單向（主→從）

##### 複製模式
###### 異步複製（Asynchronous）
- **工作流程**：
  1. 客戶端寫入主數據庫
  2. 事務立即確認
  3. 異步傳播到從數據庫
- **優點**：
  - 寫入延遲低
  - 主從故障互不影響
- **缺點**：
  - 數據最終一致性
  - 主故障可能導致數據丟失

###### 同步複製（Synchronous）
- **工作流程**：
  1. 客戶端寫入主數據庫
  2. 同步傳播到從數據庫
  3. 從庫確認後事務才完成
- **優點**：
  - 數據強一致性
  - 無數據丟失風險
- **缺點**：
  - 寫入延遲高
  - 從庫故障影響寫入可用性

##### 應用場景
- **異步複製**：讀副本，提高讀取性能和擴展性
- **同步複製**：備份副本，保證數據安全和可用性

#### 主主複製（Master-Master）
##### 架構特點
- **對等節點**：兩個都是主節點
- **訪問方式**：客戶端可在任一節點讀寫
- **複製方向**：雙向複製
- **常用模式**：異步複製

##### 挑戰
- **寫入衝突**：同時修改相同記錄
- **事務排序**：時鐘偏差導致順序問題
- **衝突解決**：需要業務規則處理衝突

##### 適用場景
- **全球部署**：不同大洲的數據中心
- **低延遲寫入**：用戶就近寫入
- **高可用性**：任一節點故障不影響服務

### 典型數據庫架構
```
主數據庫（寫入 + 讀取）
    ↓ 異步複製
多個讀副本（僅讀取）
    ↓ 同步複製  
備份副本（高可用性）
```

## 🎯 技術選擇指南

### Web層複製選擇
| 場景 | 推薦方案 | 理由 |
|-----|----------|------|
| 極低延遲要求 | 有狀態複製 | 內存訪問最快 |
| 高可擴展性 | 無狀態複製 | 不受內存限制 |
| 一般Web應用 | 無狀態+緩存 | 平衡性能與擴展性 |

### 數據庫複製選擇
| 需求 | 推薦方案 | 說明 |
|-----|----------|------|
| 高讀取擴展 | 主從+異步複製 | 多讀副本分擔負載 |
| 數據零丟失 | 主從+同步複製 | 用於備份保證 |
| 全球低延遲 | 主主複製 | 就近寫入，注意衝突 |
| 簡單可靠 | 主從複製 | 避免寫入衝突 |

## 💡 關鍵要點總結

1. **無狀態優先**：在Web和服務層優先選擇無狀態架構
2. **緩存補償**：通過共享緩存彌補無狀態架構的延遲劣勢
3. **讀寫分離**：數據庫通過主從複製實現讀寫分離和負載分擔
4. **備份同步**：使用同步複製保證備份數據一致性
5. **衝突避免**：主從複製避免寫衝突，主主複製需要衝突解決機制
6. **全局考慮**：分佈式系統需要考慮網絡延遲和數據一致性平衡
